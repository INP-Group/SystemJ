<HTML>
<HEAD>
<TITLE>Библиотека Knobs&nbsp;&#151; руководство программиста</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../style.css">
</HEAD>
<BODY>

<H1>Библиотека Knobs&nbsp;&#151; руководство программиста</H1>

<H2>Введение</H2>

<P>Библиотека Knobs предоставляет возможность создания управляющих
&laquo;ручек&raquo; для использования в системе управления.

<P>Библиотека состоит из двух компонентов: стандарта Knobs,
определенного в include-файлах <TT>Knobs*.h</TT>, и собственно
библиотеки, предоставляющей вариант реализации этого стандарта
<I>(в принципе возможно создание других реализаций, но едва ли это
когда-либо понадобится)</I>.

<P>Библиотека написана на основе Motif+Xt+<A HREF="Xh.html">Xh</A>.


<H2>Принципы устройства и функционирования библиотеки Knobs</H2>

<HR>

<P>Предусматривается два варианта использования библиотеки:

<OL>

<LI>&laquo;Нативный&raquo;, когда прикладная программа сама (а
чаще&nbsp;&#151; с использованием библиотеки <A
HREF="Cdr.html">Cdr</A>) создает стркутуры <CODE>knobinfo_t</CODE> и
предоставляет методы для взаимодействия Knobs с собой.

<LI>&laquo;Упрощенный&raquo; (simple), при этом используется
собственный интерфейс библиотеки Knobs для создания структур
<CODE>knobinfo_t</CODE>.  В упрощенном варианте структура типа
<CODE>Knob</CODE> для прикладной программы является &laquo;черным
ящиком&raquo;.  При этом также отключаются те функции, для которых
требуется кооперация от прикладной программы&nbsp;&#151; например,
звуковая сигнализация.

</OL>


<H2>Интерфейс simple-knobs</H2>

<P>При использовании простого интерфейса в программе достаточно
включать header-файл <TT>"Knobs.h"</TT>.

<P>Предоставляются две функции: создание новой &laquo;ручки&raquo; и
установка значения в ручке.

<!--
<P>При использовании простого интерфейса появляется зависимость от
библиотеки <A HREF="useful.html">useful</A> (используется модуль
<A HREF="useful.html#paramstr_parser">paramstr_parser</A>).
-->

<H3>Создание простых ручек:</H3>

<BLOCKQUOTE><PRE>
typedef void (*simpleknob_cb_t)(Knob k, double v, void *usrptr);

Knob         CreateSimpleKnob(const char      *spec,    // Knob specification
                              XhWidget         parent,  // Parent widget
                              simpleknob_cb_t  cb,      // Callback proc
                              void            *usrptr); // Pointer to pass to cb
</PRE></BLOCKQUOTE>

<P>Параметры:

<BLOCKQUOTE CLASS=excerpt>
<TABLE BORDER=0>

<TR VALIGN=top><TH ALIGN=left>spec</TH><TD>текстовое описание, какую
ручку надлежит создать (детали см. в Приложении).</TD></TR>

<TR VALIGN=top><TH ALIGN=left><DT>parent</TH><TD>parent-widget для
создаваемой ручки.</TD></TR>

<TR VALIGN=top><TH ALIGN=left><DT>cb</TH><TD>callback-процедура,
которая будет вызываться при выборе/вводе пользователем нового значения
ручки.</TD></TR>

<TR VALIGN=top><TH ALIGN=left><DT>usrptr</TH><TD>параметр, который надо
передавать callback-процедуре для данной ручки.</TD></TR>

</TABLE>
</BLOCKQUOTE>

<P>Результат: при успешном создании ручки возвращается она сама,
при ошибке&nbsp;&#151; <CODE>NULL</CODE>.


<H3>Установка текущего значения ручки</H3>

<BLOCKQUOTE><PRE>
void         SetKnobValue(Knob k, double v);
</PRE></BLOCKQUOTE>

<P>Здесь все очень просто&nbsp;&#151; ручке <CODE>k</CODE> уставляется
значение <CODE>v</CODE>.


<H3>Получение виджета ручки</H3>

<P>Почти всегда в прикладных программах требуется иметь widget-ID
виджета, отображующего ручку&nbsp;&#151; для того, чтобы как-то его
расположить.  Для этого служит функция

<BLOCKQUOTE><PRE>
XhWidget     GetKnobWidget(Knob k);
</PRE></BLOCKQUOTE>

<P>Здесь все еще проще&nbsp;&#151; возвращается widget-ID для указанной
ручки.

<H2>Приложение: синтаксис описания простых ручек</H2>

<P>Для описания параметров простых ручек используется текстовый формат вида

<BLOCKQUOTE><PRE>param1=value param2=value...</PRE></BLOCKQUOTE>

Параметры разделяются пробелами, значение параметра отделяется от имени
символом &laquo;равно&raquo;&nbsp;&#151; <TT>'='</TT>.  При
необходимости вставить в значение параметра пробел значение заключается
в кавычки.  Для вставки специальных символов может использоваться
символ бэкслэш&nbsp;-- <TT>'\'</TT>; распознаются все двухсимвольные
комбинации стандарта ANSI&nbsp;C.  <I>(Парсинг строки параметров
выполняется модулем

<A HREF="useful.html#paramstr_parser">paramstr_parser</A>,

так что можно использовать все его возможности.)</I>

<H3>Параметры, их применение и возможные значения</H3>

<SMALL><I>(Параметры приведены в том же порядке, как они идут в
структуре <CODE>knobinfo_t</CODE>)</I></SMALL>

<TABLE BORDER=1 CELLSPACING=0>

<TR VALIGN=top>

<TH>Параметр</TH>
<TH>Тип</TH>
<TH>Умолч.</TH>
<TH>Значение, варианты</TH>

</TR>

<!--  -->
<TR VALIGN=top><TH ALIGN=left>rw,ro</TH><TD>флаг</TD><TD>rw</TD>

<TD>Тип ручки: для ввода (rw&nbsp;&#151; read/write) или только для
отображения (ro&nbsp;&#151; readonly).

</TD></TR>

<!--  -->
<TR VALIGN=top><TH ALIGN=left>label</TH><TD>строка</TD><TD>NULL</TD>

<TD>Метка, отображаемая на ручке (если вид ручки это
поддерживает&nbsp;&#151; например, кнопки и &laquo;лампочки&raquo;).

</TD></TR>

<!--  -->
<TR VALIGN=top><TH ALIGN=left>units</TH><TD>строка</TD><TD>NULL</TD>

<TD>Название единиц измерения.  Используется видами ручек TEXT и DIAL.

</TD></TR>

<!--  -->
<TR VALIGN=top><TH ALIGN=left>dpyfmt</TH><TD>строка</TD><TD><TT>%8.3f</TT>&nbsp;</TD>

<TD>Строка формата для тех ручек, которые выводят значение в числовом
виде (TEXT, DIAL, SLIDER).

<P><I>(Библиотека Cdr также использует это поле при сохранении режима в
файл и в log-файл.)</I>

</TD></TR>

<!--  -->
<TR VALIGN=top><TH ALIGN=left>widdepinfo</TH><TD>строка</TD><TD>NULL</TD>

<TD>Служит для передачи разной дополнительной информации, в зависимости
от вида ручки (используется видами SELECTOR и SLIDER).

</TD></TR>

<!--  -->
<TR VALIGN=top><TH ALIGN=left>comment</TH><TD>строка</TD><TD>NULL</TD>

<TD>Строка комментария, в дополнение к короткой метке.  Уставляется в
качестве tooltip'а.

<!--
Непосредственно
в Knobs не используется, но может приниматься во внимание
программами либо библиотеками более высокого уровня&nbsp;&#151;
например, Chl при непустом комментарии ставит его в качестве tooltip'а
на ручку.
-->

</TD></TR>

<!--  -->
<TR VALIGN=top><TH ALIGN=left>look</TH><TD>селектор</TD><TD>text</TD>

<TD>Вид ручки.

<TABLE BORDER=0>

<TR VALIGN=top><TH ALIGN=left>text</TH>
<TD>Текстовое поле.  Если это ручка для ввода, то справа от текстового
поля отображаются еще кнопочки &laquo;вверх/вниз&raquo; для
увеличения/уменьшения значения мышью.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>textnd</TH>
<TD>Полностью аналогично text, но экранные стрелки вверх/вниз 
отсутствуют всегда</TD></TR>

<TR VALIGN=top><TH ALIGN=left>alarm</TH>
<TD>Лампочка сигнализации.  Зажигается, когда уставленное значение не
равно нулю.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>onoff</TH>
<TD>Кнопочка включено/выключено.  Включенным считается состояние, когда
уставленное значение не равно нулю.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>greenled,<BR>amberled,<BR>redled,<BR>blueled</TH>
<TD>Зеленая, оранжевая, красная и синяя &laquo;лампочки&raquo;.  Они
зажигаются, когда уставленное значение не равно нулю.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>radiobtn</TH>
<TD>"Радиокнопка". Поведением никак не отличается от led'ов, но имеет
круглую форму.  Во включенном состоянии подсвечивается голубым. 
<I>(Предполагается, что "радио-поведение" обеспечивает пользовательская
программа.  Обычно стоит также указывать ключ
<B>local</B>.)</I></TD></TR>

<TR VALIGN=top><TH ALIGN=left>dial</TH>
<TD>Стрелочный индикатор.  Диапазон, отображаемый на индикаторе,
определяется параметрами mindisp,maxdisp.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>button</TH>
<TD>Кнопка.  Имеет смысл только в качестве ручки для ввода.  При
нажатии на нее генерирует значение 1.  Смысл имеет не само значение,
а факт нажатия.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>selector</TH>
<TD>Селектор для выбора одного из нескольких вариантов (OptionMenu). 
Каждому пункту соответствует число, являющееся его порядковым номером в
списке, начиная с нуля.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>light</TH>
<TD>&laquo;Светильник&raquo;.  Самая простая ручка.  Данный вид ручки
имеет смысл только для отображения.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>hslider<BR>vslider</TH>
<TD>Горизонтальный и вертикальный слайдеры.  Диапазон отображаемых
значений определяется параметрами mindisp,maxdisp.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>arrow_lt,<BR>arrow_rt,<BR>arrow_up,<BR>arrow_dn</TH>
<TD>Кнопки-стрелки влево, вправо, вверх и вниз.  Функционируют
полностью идентично button.</TD></TR>

</TABLE>

</TD></TR>

<!--  -->
<TR VALIGN=top><TH ALIGN=left>color</TH><TD>селектор</TD><TD>normal</TD>

<TD>Тип расцвечивания.

<TABLE BORDER=0>

<TR VALIGN=top><TH ALIGN=left>normal</TH>
<TD>&laquo;Обыкновенная&raquo; ручка.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>hilited</TH>
<TD>&laquo;Подсвеченная&raquo;.  В стандартной палитре имеет фиолетовый
цвет вместо черного.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>important</TH>
<TD>&laquo;Важная&raquo;.  Аналогично hilited, но выделяется голубым
цветом. Плюс, при выходе за границы диапазонов important-каналы
подсвечиваются более яркими цветами.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>vic</TH>
<TD>&laquo;Очень важная&raquo; (Very Important Channel).  Имеет
бледно-зеленый фон.</TD></TR>

<TR VALIGN=top><TH ALIGN=left>dim</TH>
<TD>&laquo;Бледная&raquo;, &laquo;маловажная&raquo;.  Имеет серый цвет
вместо черного.</TD></TR>

</TABLE>

</TD></TR>

<!--  -->
<TR VALIGN=top><TH ALIGN=left>minnorm,maxnorm<BR>minyelw,maxyelw</TH><TD>double</TD><TD>0.0,0.0<BR>0.0,0.0</TD>

<TD>Границы &laquo;нормального&raquo; (за ними начинается
&laquo;желтый&raquo;) и &laquo;желтого&raquo; (за ними расположен
&laquo;красный&raquo;) диапазонов.

<P>В современной версии Knobs расцвечивание по выходу за границы этих
диапазонов (кажется) не выполняется -- эта задача возложена на Cdr.

<P>Но при вводе значения пользователем оно ограничивается в
соответствии с диапазонами; если указан &laquo;желтый&raquo; диапазон,
то им, иначе&nbsp;&#151; &laquo;нормальным&raquo;; если не указан ни
один из диапазонов, то ввод не ограничивается.  (Диапазон считается
указанным, если у него <I>min&lt;max</I>.)

</TD></TR>

<!--  -->
<TR VALIGN=top><TH ALIGN=left>mindisp,maxdisp</TH><TD>double</TD><TD>0.0,0.0</TD>

<TD>Диапазон отображения.  Используется видами DIAL и SLIDER

</TD></TR>

<!--  -->
<TR VALIGN=top><TH ALIGN=left>step</TH><TD>double</TD><TD>1.0</TD>

<TD>Шаг при изменении значения стрелками с клавиатуры либо экранными
стрелками &laquo;больше/меньше&raquo;.  Реально используется видами
TEXT, DIAL и SLIDER.

</TD></TR>

<!--  -->
<TR VALIGN=top><TH ALIGN=left>local</TH><TD>флаг</TD><TD>0</TD>

<TD>Указывает, что ручка является "локальной", т.е. не связана ни с
каким реальным удаленным устройством.  Этот флаг отключает "механизм
wasjustset", отсрочивающий программное обновление ручки на один цикл.

<P><SMALL><I>Примечание: это псевдо-параметр -- реально он отражается
на "флаг поведения" <CODE>KNOB_B_NO_WASJUSTSET</CODE> в поле
<CODE>knobinfo_t.behaviour</CODE>.</I></SMALL>

</TD></TR>

</TABLE>

</BODY>
</HTML>
