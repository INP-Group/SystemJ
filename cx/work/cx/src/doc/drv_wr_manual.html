<HTML>
<HEAD>
<TITLE></TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="style.css">
</HEAD>
<BODY>

<H1 ALIGN=center>Руководство программисту по созданию драйверов сервера
системы CX версии 2.</H1>

  <H2>Структура и методы драйвера</H2>

  <H2>API сервера для драйверов</H2>

  <H2>Логика работы драйвера</H2>

  <H2>Форматы данных</H2>

    <H3>ЦАП и АЦП</H3>

<P>Все значения, связанные с ЦАП и АЦП ДОЛЖНЫ быть в микровольтах.  Это
преобразование следует производить непосредственно в драйвере, сразу
после чтения кода из устройства и непосредственно перед записью кода в
устройство.

<P>Резоны:

<OL>

<LI>Такой подход обеспечивает независимость уровней, расположенных выше
драйверов, от специфики конкретных устройств.  И позволяет даже
прозрачно производить замену одних устройств на другие (даже со сменой
стандарта электроники, например, CAMAC на CAN-bus).

<LI>Более того -- у многих интегрирующих АЦП код и реальное напряжение
связаны довольно сложной формулой, зависящей от параметров измерения,
и, следовательно, получить напряжение из кода простой формулой вида
<I>Напряжение=Код*Коэффициент</I> невозможно в принципе.

<LI>Подавляющее большинство используемых устройств имеют разрядность не
выше 24&nbsp;бит (чаще -- 16 или 20) и точность (цену деления) десятки,
а то и сотни микровольт, поэтому (в рамках 32&nbsp;бит) перевод в
микровольты не приводит к потере точности.

<LI>С другой стороны -- микровольты более чем адекватны для
подавляющего большинства приложений, давая даже некоторый избыток
точности, что обеспечивает повышенную гибкость и надежность.

</OL>

<P>Разрешенные исключения из данного правила:

<UL>

<LI>Если устройство является ЦАП/АЦП-подобным, но тем не менее работает
с некими абстрактными единицами.  В таких случаях СЛЕДУЕТ использовать
непосредственно единицы прибора, выполняя лишь некие специфичные
унифицирующие преобразования <I>(например, в некоторых устройствах
вычитываемый и записываемый коды не совпадают -- естественно, это
проблема драйвера; кроме того, если прибор может работать в нескольких
режимах, то единицы данных от режима зависеть не должны)</I>.

<P>Пример&nbsp;-- ПКС-8 (Г-0603).

<LI>Если устройство весьма специфично и его собственные единицы
измерения уже являются достаточно "натуральными", то СЛЕДУЕТ
пользоваться ими.

<P>Пример&nbsp;1&nbsp;-- АЦПТ-16 (Ц-0601), возвращающий температуру
сразу в градусах.

<P>Пример&nbsp;2&nbsp;-- ИВА-16 (Ц-0602) и CANIVA, у которых для токов
и их пределов цена деления 0.1uA, а для напряжений и их
пределов&nbsp;-- 0.1kV.

</UL>

    <H3>Булевские каналы</H3>

<P>Булевскими являются каналы, "отдающие" значения
"<I>включено/выключено</I>", например, СДС, а также получающие такие
значения -- например, УР.

<P>Булевские каналы всегда ДОЛЖНЫ возвращать только <CODE>0</CODE> для
состояния "выключено" и только <CODE>1</CODE> для состояния "включено"
<I>(но ни в коем случае не 2, 4, или прочее число вне диапазона
[0,1])</I>.  Это необходимо, в частности, для возможности производить
умножение на значение такого канала, обходясь без проверки "if".

<P>При записи в такой канал любое число, не равное нулю, ДОЛЖНО
рассматриваться как <CODE>1</CODE> (или при помощи "if", или
предварительной "буленизацией" -- "<CODE>v=(v!=0);</CODE>").

<P>Помимо того, что использование для булевских каналов только значений
[0,1] является правильным из общих соображений, именно эти значения
поддерживаются управляющими элементами из библиотеки Knobs, в
частности:

<UL>

<LI>Элемент "переключатель" (ONOFF) посылает значение 1 при переходе в
состояние "включено" и 0 при переходе в "выключено".

<LI>Элементы "тревога" (ALARM) И "лампочки" (все *LED) рассматривают
значение бита по маске 1: уставленное -- как "включено", сброшенное --
как "выключено".

</UL>


    <H3>Командные каналы</H3>

<P>Командными являются каналы типа "пуск" -- например, старт шагового
двигателя.

<P>Для командных каналов играет роль именно факт записи, а не само
значение.  Само же записываемое значение же в общем случае может быть
произвольным.

<P>Возвращаемое же значение имеет собственную нагрузку:

<UL>

<LI>Бит по маске <CODE>CX_VALUE_LIT_MASK</CODE> является командой
отображающему элементу "подсветиться" (это может быть, например,
состояние "наезд на концевик") -- аналогично булевским каналам.

<LI>Бит по маске <CODE>CX_VALUE_DISABLED_MASK</CODE> является командой
отображающему элементу перейти в состояние "запрещено" (insensitive,
disabled) -- например, для запрета дальнейших команд "пуск" на время
отработки операции.

<P><I>(Но следует понимать, что состояние "запрещено" -- это лишь
подсказка для пользователя, но никак не гарантия от прихода повторных
команд записи.)</I>

</UL>

<P>В обычном состоянии возвращаемое значение ДОЛЖНО равняться 0.


</BODY>
</HTML>
