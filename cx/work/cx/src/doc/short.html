<HTML>
<HEAD>
<TITLE>Система управления CX &#151; краткое руководство по эксплуатации</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="style.css">
</HEAD>
<BODY>


<H1>Система управления CX&nbsp;&#151; краткое руководство по эксплуатации</H1>


<H2>Общие сведения</H2>

<P>Изначально аббревиатура "CX" расшифровывалась как <I>&#147;Control
system for uniX&#148;</I>.  В настоящее время это просто имя
собственное.  На данный момент (06.03.2013) текущей является версия 2,
сетевой протокол версии 3.0.1.  Описание используемых в CX концепций
содержится в [1].

<P>CX является распределённой системой управления, построенной по так
называемой <I>&laquo;3-уровневой стандартной модели&raquo;</I> [1,
с.15].  Верхний уровень -- прикладные и операторские программы, нижний
уровень -- управляющая электроника, средний уровень -- сервер. 
Взаимодействие между компонентами идёт через сеть, в основном по
протоколу TCP.

<P>CX предназначена для работы под управлением POSIX-совместимых ОС, в
первую очередь -- Linux.  Поддерживаются как 32-битная архитектура
(i386, i586, i686), так и 64-битная (x86_64).

<P>Часть компонентов, предназначенных для работы на удалённых
встраиваемых контроллерах (CM5307, CANGW, BIVME2, MOXA UC-7112) с
процессорами PowerPC и ARM, также входит в состав системы и собирается
при помощи кросс-компиляции.  Кросс-средства расположены в отдельной
директории <TT>x-compile</TT> и требуют x86-совместимого процессора
(x86_64 подходит).

<P>Графические приложения в составе СУ сделаны на основе Motif, поэтому
для работы требуется наличие пакета openmotif (и его зависимостей), а
для сборки -- дополнительно openmotif-devel (и его зависимостей).


<H2>Требования к ОС на хост-компьютере</H2>

<H3>Пользователь и директории</H3>

<H4>Локальное использование</H4>

<P>Предполагается, что CX работает под пользователем <TT>oper</TT>, и
устанавливается в его home-директории в поддиректорию <TT>pult/</TT>,
т.е., <TT>~oper/pult/</TT>.

<P>Не является проблемой любое другое имя, но желательно иметь
одинаковые имена на серверных и клиентских компьютерах, а кроме того,
удалённые контроллеры всегда ожидают <TT>oper</TT> (см. ниже).


<H4>Использование удалёнными контроллерами</H4>

<P>Удалённые контроллеры запускают свою часть (драйвера) с файловой
системы хост-компьютера, получая доступ к директории CX по NFS.

<P>Поскольку расположение самих home-директорий может быть разным
(например, /home, /mnt/home, /export/имя-компьютера), то удалённые
контроллеры предполагают, что home-директории доступны по адресу
<TT>/export/HOST</TT> (т.е., используют путь
<TT>/export/HOST/oper/pult</TT>).

<P>Для того, чтобы home-директории были доступны по этому пути
независимо от своего реального расположения, следует воспользоваться
bind-монтированием.  Например, если реально home-директории расположены
в <TT>/home</TT>, то следует поместить в <TT>/etc/fstab</TT> следующую
строку:

<BLOCKQUOTE><CODE>/home  /export/HOST  none  bind 0 0</CODE></BLOCKQUOTE>

Естественно, эта строка должна идти после строки, монтирующей саму
<TT>/home</TT>, а кроме того, директория <TT>/export/HOST</TT> должна
быть предварительно создана.

<P>К сожалению, bind-монтирование с NFS-экспортом может не работать с
директориями, которые сами смонтированы по NFS (поскольку ре-экспорт
NFS директорий обычно запрещён).  В такой ситуации проще будет для
пользования контроллерами создать локальную директорию
<TT>/export/HOST/oper/pult</TT> с требуемым контроллерами наполнением,
либо в качестве хост-компьютера для контроллеров использовать тот же
самый NFS-сервер, с которого монтируются home-директории обычными
компьютерами.

<P>В случае, если по какой-то причине данная схема с
<TT>/export/HOST</TT> не подходит вовсе, может быть использована другая
директория -- подробности см. в разделе о настройке контроллеров.


<H3>Сеть: файрволл, удалённый доступ по ssh, NFS</H3>

<H4>Файрволл</H4>

<P>Для сетевого взаимодействия между клиентами и сервером используется
протокол TCP.  Сервер экземпляра :N слушает порт с номером 8012+N. 
Таким образом, для возможности работы всего поддерживаемого диапазона
серверов (0-59) требуется разрешить доступ к портам 8012-8111. 
Например, в системах на базе RHEL5 для этого надо добавить в файл
<TT>/etc/sysconfig/iptables</TT> перед строкой "...-j REJECT..." строку

<BLOCKQUOTE><CODE>-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 8012:8111 -j ACCEPT</CODE></BLOCKQUOTE>

а в системах на базе RHEL6 -- строку

<BLOCKQUOTE><CODE>-A INPUT -m state --state NEW -m tcp -p tcp --dport 8012:8111 -j ACCEPT</CODE></BLOCKQUOTE>


<H4>Удалённый доступ по ssh</H4>

<P>При использовании на компьютерах (кроме самого серверного) системы
запуска на основе CX-starter она будет сама запускать серверные
процессы на серверном компьютере при помощи удалённого исполнения
команд посредством ssh.

<P>Следовательно, при этом требуется беспарольный доступ с клиентских
компьютеров на серверный (например, на основе ключей).


<H4>NFS</H4>

<P>При использовании удалённых контроллеров (CM5307, CANGW, Moxa) им
нужно открыть по NFS доступ на чтение к директории
<TT>/export/HOST</TT>.

<P>Для этого обычно достаточно добавить в файл <TT>/etc/exports</TT>
строку вида

<BLOCKQUOTE><CODE>/export/HOST 192.168.2.*(ro)</CODE></BLOCKQUOTE>

(заменив "192.168.2.*" на шаблон сети, используемой для контроллеров).

<P>Кроме этого, естественно, сам сервис NFS должен быть запущен и на
файрволле разрешен доступ контроллерам к порту mountd.  Например, в
системах на основе RHEL5/6 для этого можно раскомментировать в
<TT>/etc/sysconfig/nfs</TT> строку <CODE>MOUNTD_PORT=892</CODE> и
разрешить на файрволле входящие соединения на порт 892 по udp и tcp.

<H2>Состав дистрибутива</H2>

<P>Дистрибутив включает несколько директорий-компонентов.

  <DL>

  <DT><TT>cx</TT></DT><DD> ядро CX, включает библиотеки, сервер, стандартные
клиентские программы и утилиты.

  <DT><TT>x-compile</TT></DT><DD> кросс-среды для сборки под
PowerPC-860/Linux (CM5307/PPC, CANGW, BIVME2) и ARM/Linux (Moxa
UC-7112).

  <DT><TT>v2hw</TT></DT><DD> поддержка измерительно-управляющей
аппаратуры, используемой в ИЯФ (CAMAC, CAN, VME, cPCI, ...).  Это
включает драйвера, диагностические панели и стандартные клиентские
программы, а также конфигурационные файлы для удалённых контроллеров.

  <DT><TT>qult</TT></DT><DD> ПО для Инжекционного комплекса ВЭПП-5, в
т.ч. драйверы некоторой специфической аппаратуры (ИСТ).

  <DT><TT></TT></DT><DD>

  <DT><TT></TT></DT><DD> 


  </DL>



<H2>Сборка и установка</H2>

<P>Дистрибутив текущей на момент написания версии доступен по адресу

<BLOCKQUOTE><A HREF="http://www.inp.nsk.su/~bolkhov/tmp/work-controlsys-20140121.tar.gz">http://www.inp.nsk.su/~bolkhov/tmp/work-controlsys-20140121.tar.gz</A></BLOCKQUOTE>


<H3>Сборка</H3>

<P>Сборка производится при помощи утилиты "make" (точнее, требуется
вариант GNU Make, но в Linux он является стандартом).

<P><B>Замечание:</B> предполагается, что распаковка дистрибутива и его
сборка будет производиться в директории <TT>$HOME/work</TT>, на неё по
умолчанию настроены все компоненты.  Можно проводить сборку и в другой
директории, но для этого всем компонентам <B>(кроме самой
<TT>cx</TT>!)</B> надо указывать расположение директорий <TT>cx/src</TT>
и <TT>v2hw</TT>. Например, если дистрибутив распакован в директорию
/SOME/PATH, то в командной строке "make" надо дополнительно указывать
параметры 

<BLOCKQUOTE><CODE>TOPDIR=/SOME/PATH/cx/src V2HDIR=/SOME/PATH/v2hw</CODE></BLOCKQUOTE>

<SMALL><I>(сама основная директория <TT>cx</TT> этого не требует, так
же как и <TT>v2hw</TT> не требует указания
<CODE>V2HWDIR</CODE>)</I></SMALL>.

<P>Для сборки следует выполнить следующие команды:

<BLOCKQUOTE><PRE>
make -C $HOME/work/cx/src create-exports exports
make -C $HOME/work/v2hw
make -C $HOME/work/qult
</PRE></BLOCKQUOTE>

(и аналогично для других директорий из состава дистрибутива, если
потребуется).


<H3>Установка</H3>

<H4>Установка на компьютер</H4>

<P>Установка производится при помощи команды "make install", но она, в
отладочных целях, по умолчанию устанавливает всё в <TT>/tmp/cx</TT>. 
для установки в <TT>$HOME/pult</TT> следует выполнить следующие команды

<BLOCKQUOTE><PRE>
make -C $HOME/work/cx/src install PREFIX=$HOME/pult
make -C $HOME/work/v2hw   install PREFIX=$HOME/pult
</PRE></BLOCKQUOTE>

(и аналогично для других директорий из состава дистрибутива, если
потребуется).

<P>При необходимости выполнять автоматический старт и останов
CX-серверов при загрузке и выключении серверного компьютера следует
выполнить следующие шаги из-под пользователя <TT>root</TT> (предполагается
использование стандартной системы запуска на основе init, как в
RHEL5/6):

  <UL>

  <LI>Поместить файл <TT>cx/src/doc/etc_init.d_cx-servers</TT> в
<TT>/etc/init.d/cx-servers</TT>.

<P>(В нём предполагается, что CX установлена в директорию
<TT>~oper/pult/</TT>; в ином случае следует изменить путь запуска,
указанный в переменной <CODE>START_SERVERS</CODE>.)

  <LI>Исполнить команду

<PRE>
chkconfig --add cx-servers
</PRE>

  <LI>Поместить список номеров используемых серверов (через пробел) в
файл <TT>~oper/pult/configs/cx-servers-HOSTNAME.conf</TT>.

<P>Здесь HOSTNAME -- это первый компонент DNS-имени компьютера, все
буквы маленькие; его можно получить при помощи команды

<PRE>
hostname -s|tr A-Z a-z</CODE>
</PRE>

  </UL>


<H4>Настройка удалённых контроллеров</H4>

<P>Файлы, требуемые для настройки контроллеров для работы с CX,
доступны в директории <TT>v2hw/etc/</TT>.

<P>В частности, контроллеры CM5307/PPC, CANGW и BIVME2, имея одинаковую
архитектуру процессорной платы и различаясь лишь периферийными
устройствами, используют унифицированный набор файлов, с различными
файлами специфичной настройками аппаратуры и сред запуска драйверов.

<P>Общие для этих типов контроллеров файлы доступны в директории
<TT>v2hw/etc/ppc860-unified/</TT>, и включают <TT>eth0.conf</TT>,
<TT>mounthost.sh</TT>, <TT>rc.sh</TT> (последний заменяет стандартный
файл, имеющийся в ненастроенном контроллере).

<P>Специфичные файлы доступны в поддиректориях <TT>CM5307PPC/</TT>,
<TT>CANGW/</TT> и <TT>BIVME2/</TT> соответственно, и включают
<TT>arch.conf</TT>, <TT>rc.banner</TT>, <TT>rc.hardware</TT>,
<TT>rc.local</TT>.

<P>Для настройки следует выполнить следующие действия (все шаги, кроме
первого, выполняются на самом контроллере):

  <OL>

  <LI>Скопировать требуемые файлы -- <TT>eth0.conf</TT>,
<TT>mounthost.sh</TT>, <TT>rc.sh</TT>, <TT>arch.conf</TT>,
<TT>rc.banner</TT>, <TT>rc.hardware</TT>, <TT>rc.local</TT> -- на
контроллер, в директорию <TT>/etc/</TT>.

<P>Это можно сделать, например, при помощи <CODE>ftp</CODE> (по
умолчанию контроллеры используют для пользователя
<TT>root</TT> пароль также <TT>root</TT>; IP-адрес по умолчанию у них
обычно 192.168.1.2).

  <LI>Большинство этих файлов надо сделать исполняемыми:

<BLOCKQUOTE><PRE>
cd /etc
chmod +x mounthost.sh rc.sh rc.banner rc.hardware rc.local
</PRE></BLOCKQUOTE>

  <LI>Настроить сетевой адрес в файле <TT>/etc/eth0.conf</TT>.

<P>В первой строке (MY_NET) указывается адрес сети, во второй (MY_HOST)
-- адрес хост-компьютера в ней, а в третьей (MY_TAIL) -- последний
компонент IP-адреса самого контроллера.  В примере в дистрибутиве
контроллер имеет адрес 192.168.2.207, а хост-компьютер --
192.168.2.254.  Редактировать файлы в контроллере можно при помощи
<CODE>vi</CODE> или <CODE>joe</CODE>.

<P><B>Замечание:</B> используемая в контроллерах система стартовых
скриптов предполагает работу с сетью класса "C".  Практически всегда
так и есть.

  <LI>[Опционально] В случае, если хост-компьютер экспортирует
контроллерам не <TT>/export/HOST</TT>, а какую-то иную директорию, то
надо отразить это в <TT>arch.conf</TT>, добавив туда строку вида
<CODE>ARCH_MNTDIR=PATH</CODE> (где PATH -- тот путь).

<P>Аналогично может потребоваться настроить и путь, в котором
расположены файлы для данного вида контроллеров.  Это указывается в
параметре <CODE>ARCH_SUBDIR</CODE>.

  <LI>Сохранить настройки при помощи команды <CODE>writeflash</CODE>.

  <LI>Перезагрузить контроллер командой <CODE>reboot</CODE>.

  </OL>


<H2>Литература</H2>

<OL>

<LI>Д.Ю.Болховитянов,

"<A HREF="http://www.inp.nsk.su/~bolkhov/publs/bolkhov_phd_final.pdf">Программное

обеспечение системы управления Инжекционного комплекса ВЭПП-5</A>",
кандидатская диссертация, 2007г.

</OL>

</BODY>
</HTML>
