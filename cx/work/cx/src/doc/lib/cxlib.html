<HTML>
<HEAD>
<TITLE>Использование библиотеки cxlib</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../style.css">
</HEAD>
<BODY>


<H2>Обработка ошибок</H2>


<H2>Режимы работы библиотеки</H2>

<P>По умолчанию cxlib работает в режиме "по сигналу": библиотека
устанавливает обработчик сигнала <CODE>SIGIO</CODE>, и когда приходят
данные от сервера, то обработчик вызывается, вычитывает данные, и при
надобности вызывает зарегистрированную прикладной программой
callback-функцию.

<P>Однако есть две ситуации, при которых такой "простой" подход не
сработает:

<OL>

<LI>Если cxlib является не единственным в программе пользователем
<CODE>SIGIO</CODE>.

<LI>Если инфраструктура прикладной программы (например, ее
GUI-библиотека) нереентерабельна и при этом не имеет поддержки
"асинхронных сигналов".

</OL>

<P>Для поддержки таких случаев cxlib имеет несколько режимов работы, в
частности, режим с каскадированием обработки <CODE>SIGIO</CODE> и режим
работы по опросу.

<P>Режим работы устанавливается функцией

<BLOCKQUOTE CLASS=excerpt><PRE>
cx_setlibmode (cx_lib_mode_t mode);
</PRE></BLOCKQUOTE>

Эта функция может быть вызвана только один раз, в самом начале
программы, ДО открытия первого cx-соединения.

<P>Параметр <CODE>mode</CODE> может принимать одно из следующих
значений:

<DL>

<DT><CODE>CXLIB_MODE_SIGIO_MASTER</CODE><DD>Умолчательный режим работы,
по сигналу.  Cxlib устанавливает обработчик сигнала самостоятельно и
считает себя основным пользователем <CODE>SIGIO</CODE>.  При этом можно
установить дополнительный, "подчиненный" обработчик, который будет
вызываться после собственного обработчика cxlib.

<DT><CODE>CXLIB_MODE_SIGIO_HARSHMASTER</CODE><DD>То же самое, что
<CODE>CXLIB_MODE_SIGIO_MASTER</CODE>, но после каждого вызова
дополнительного обработчика сигнал перехватывается заново.  Требуется в
случаях, когда подчиненный обработчик сигнала перехватывает сигнал на
себя, для защиты от такого поведения.

<DT><CODE>CXLIB_MODE_SIGIO_SLAVE</CODE><DD>В этом режиме cxlib не
занимается перехватом <CODE>SIGIO</CODE>, а работает как "подчиненный".
Для передачи управления коду cxlib, отвечающему за чтение по сигналу данных от
сервера, библиотека предоставляет точку входа -- функцию

<BLOCKQUOTE CLASS=excerpt><PRE>
int  cx_entry_slave_sigio(int sig);
</PRE></BLOCKQUOTE>

которую "головной" обработчик должен вызвать, указав параметром код
<CODE>SIGIO</CODE> <I>(реально этот параметр используется лишь для
передачи следующему в цепочке подчиненному обработчику)</I>.

<DT><CODE>CXLIB_MODE_SELECT</CODE><DD>Режим работы по опросу.  Механизм
<CODE>SIGIO</CODE> при этом не используется вовсе, а прикладная
программа должна для каждого соединения получить его файловый
дескриптор при помощи функции

<BLOCKQUOTE CLASS=excerpt><PRE>
int  cx_fd_of(int conn);
</PRE></BLOCKQUOTE>

следить <I>(при помощи своих внутренних механизмов -- например,
XtAppAddInput() для библиотеки Xt)</I> за приходом данных, и при их
появлении вызывать функцию

<BLOCKQUOTE CLASS=excerpt><PRE>
int  cx_entry_select(void);
</PRE></BLOCKQUOTE>

</DL>

<P>Подчиненный обработчик разрешается устанавливать  в любом из режимов
семейства <CODE>CXLIB_MODE_SIGIO_</CODE>.

<P>Функции поддержки множественных режимов работы описаны ниже.  При
некорректном их использовании (как и при повторном вызове
<CODE>cx_setlibmode()</CODE>) возвращается <CODE>-1</CODE> и код ошибки
<CODE>CEWRONGUSAGE</CODE>.

<DL>

<DT><CODE>cx_setlibslave(void (*slavehandler)(int))</CODE>
<DD>Устанавливает подчиненный обработчик.  Может использоваться только
в режимах <CODE>CXLIB_MODE_SIGIO_</CODE>, но произвольное количество
раз, в том числе с параметром <CODE>NULL</CODE> для удаления
подчиненного обработчика.

<DT><CODE>cx_entry_slave_sigio(int sig)</CODE><DD>Точка входа для
режима работы <CODE>CXLIB_MODE_SIGIO_SLAVE</CODE>. В остальных режимах
возвращает код ошибки <CODE>CEWRONGUSAGE</CODE>.

<DT><CODE>cx_entry_select(void)</CODE><DD>Точка входа для режима работы
<CODE>CXLIB_MODE_SELECT</CODE>. В остальных режимах возвращает код
ошибки <CODE>CEWRONGUSAGE</CODE>.

<DT><CODE>cx_fd_of(int conn)</CODE><DD>Возвращает номер файлового
дескриптора для cx-соединения <CODE>conn</CODE>.  Может использоваться
только в режиме <CODE>CXLIB_MODE_SELECT</CODE>.

</DL>

</BODY>
</HTML>
